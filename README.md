# ortools-cp-sat-v2

Проект для экспериментов с CP-SAT из библиотеки OR-Tools и локального интерфейса подготовки входных данных.

## Требования
- Python 3.11
- [Poetry](https://python-poetry.org/)

## Подготовка окружения
1. Установите Poetry, если он ещё не установлен (см. инструкцию по ссылке выше).
2. Убедитесь, что локально доступен Python 3.11. При необходимости выберите его для виртуального окружения:
   ```bash
   poetry env use 3.11
   ```
3. Установите зависимости проекта:
   ```bash
   poetry install
   ```

## Работа с проектом
- Активируйте окружение, если нужен интерактивный сеанс:
  ```bash
  poetry shell
  ```
- Запустите FastAPI-приложение c обёрткой над CP-SAT:
  ```bash
  poetry run uvicorn order_grouping.api:app --reload
  ```
- Запускайте скрипты или модули через Poetry без активации shell:
  ```bash
  poetry run python path/to_script.py
  ```
- Для запуска тестов:
  ```bash
  poetry run pytest
  ```

## map_orders — Streamlit интерфейс подготовки входа
1. Запустите локальный OSRM:
   - Запуск с docker compose (репозиторий уже содержит `docker/osrm/docker-compose.yml`):
     ```bash
     docker compose -f docker/osrm/docker-compose.yml up
    ```
   > Примечания: используем фиксированный образ `osrm/osrm-backend:v5.25.0` (актуальный на 2025-10-02); сервис слушает `http://localhost:5563` — это значение уже установлено по умолчанию в интерфейсе `map_orders`. Если пробросите другой порт, вручную измените URL в боковой панели.
2. Запустите интерфейс:
   ```bash
   poetry run streamlit run map_orders.py
   ```
3. На странице приложения:
   - Расставьте точки на карте и импортируйте их в таблицу.
   - Отметьте ровно один `depot` и заполните параметры заказов.
   - Задайте курьеров и веса, установите T0.
   - Нажмите **«Собрать вход CP-SAT»** — при успешной валидации скачайте `solver_input.json`.
   - Экспортируйте состояние через кнопки **«Экспорт GeoJSON»** или **«Экспорт кейса»**.
   - Для восстановления состояния используйте загрузку файла в блоке **«Импорт кейса»**.

### Формат экспортируемых файлов
- `orders.geojson` — `FeatureCollection` с точками `depot/order`; свойства включают `boxes`, `created_at`, `ready_at`, `extra_json`, а также `_extra_parse_error` при сбое парсинга.
- `case_bundle.json` — бандл для полного восстановления интерфейса: содержит `t0_iso`, координаты карты, GeoJSON, `couriers`, `weights`, `osrm_base_url`.
